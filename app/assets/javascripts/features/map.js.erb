$(function() {
  var meetupMarkers = {},
      map;

  var map = window.map = new google.maps.Map(document.getElementById('map'), {
    center: {lat: 51.5073, lng: -0.12274},
    scrollwheel: false,
    zoom: 11,
    // styles:[{stylers:[{lightness:7},{saturation:-20}]}]
  });

  var markerImage = {
      url: "<%= asset_path("map-marker.png") %>",
      size: new google.maps.Size(40, 54),
      scaledSize: new google.maps.Size(20, 27),
      origin: new google.maps.Point(0,0),
      anchor: new google.maps.Point(10, 30)
  };

  function loadMeetups(city) {
    var geocoder = new google.maps.Geocoder();

    // Remove all markers
    _.each(meetupMarkers, function(marker, meetupId) {
      marker.setMap(null);
    });

    meetupMarkers = {};

    geocoder.geocode({ 'address': city }, function(results, status) {
      if (status == google.maps.GeocoderStatus.OK) {
        var location = results[0].geometry.location;

        map.setCenter(location);
        map.setZoom(11);

        $.ajax({
          url: "/meetups/nearby",
          type: "GET",
          data: {
            lat: location.lat,
            lon: location.lng
          }
        }).then(function(data) {

          var titleHtml = JST["templates/results_title"]({meta: data.meta, city: city}),
              meetupsHtml = JST["templates/meetups"]({meetups: data.meetups});

          $(".pagetitle").html(titleHtml);
          $(".meetups-list").html(meetupsHtml);

          // Append markers to the map
          data.meetups.forEach(function(meetup) {

            var infowindow = new google.maps.InfoWindow({
              content: JST["templates/meetup_marker_popup"]({meetup: meetup}),
              pixelOffset: new google.maps.Size(-10, 0)
            });

            var marker = new google.maps.Marker({
              map: map,
              position: {lat: meetup.latitude, lng: meetup.longitude},
              icon: markerImage
            });

            meetupMarkers[meetup.id] = marker;

            marker.addListener('click', function() {
              infowindow.open(map, marker);
            });
          });
        });

      } else {
        alert("Geocode was not successful for the following reason: " + status);
      }
    });
  }

  $(document).on("submit", ".search-form", function(ev) {
    loadMeetups($("#location").val());

    return false;
  });

  loadMeetups("London");

});
